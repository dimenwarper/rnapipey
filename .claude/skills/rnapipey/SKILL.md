---
name: rnapipey
description: Project context for the rnapipey RNA 3D structure prediction pipeline. Use this when working on pipeline code, adding new tools, running predictions, or debugging tool wrapper issues.
user-invocable: true
---

# rnapipey — Project Context

## What is this project?

rnapipey is an RNA 3D structure prediction pipeline. It wraps multiple external bioinformatics tools behind a unified Python CLI (typer + rich), runs them on the same FASTA input, scores the results with RNAdvisor, and picks the best model.

## Architecture

```
rnapipey/
├── cli.py              # Typer CLI (run, check, report commands)
├── config.py           # Dataclass-based YAML config loading
├── pipeline.py         # Orchestrates the 5-stage pipeline
├── report.py           # Generates summary.md + PyMOL scripts
├── utils.py            # FASTA I/O, subprocess helpers, logging
└── tools/
    ├── base.py         # BaseTool ABC (check, run, _run_cmd)
    ├── infernal.py     # Rfam/cmscan wrapper
    ├── rnafold.py      # ViennaRNA wrapper
    ├── spotrna.py      # SPOT-RNA wrapper
    ├── rhofold.py      # RhoFold+ wrapper
    ├── simrna.py       # SimRNA wrapper
    ├── protenix.py     # Protenix (AF3) wrapper
    └── rnadvisor.py    # RNAdvisor scoring wrapper
```

## Key files

- `pixi.toml` — unified conda + PyPI environment (pixi package manager)
- `pyproject.toml` — Python package metadata (hatchling build)
- `install_tools.sh` — installs git-based tools, data downloads, Docker/Colima
- `configs/default.yaml` — default tool paths (committed)
- `configs/local.yaml` — generated by install_tools.sh (gitignored)

## Environment

- **Package manager**: pixi (handles both conda and pip)
- **Conda packages**: python, infernal, viennarna, pymol-open-source, pytorch-cpu, openmm, pip
- **PyPI packages**: rnapipey (editable), protenix, rnadvisor, huggingface-hub
- **External tools dir**: `~/.rnapipey/tools/` (RhoFold+, SPOT-RNA, SimRNA)
- **Data dir**: `~/.rnapipey/data/` (Rfam CM database, RhoFold+ weights)
- **Docker**: Colima + docker CLI (for RNAdvisor scoring containers)

## Running commands

Always prefix with pixi:
```bash
pixi run rnapipey check -c configs/local.yaml
pixi run rnapipey run input.fasta -o results/ -c configs/local.yaml --rhofold -v
```

Or use `export PATH="$HOME/.pixi/bin:$PATH"` in Bash tool calls.

## Pipeline stages

1. **Sequence analysis** — Infernal cmscan against Rfam database
2. **Secondary structure** — ViennaRNA RNAfold (MFE + base pair probs)
3. **3D prediction** — One or more of: RhoFold+, SimRNA, Protenix
4. **Scoring** — RNAdvisor (runs via Docker containers: DFIRE, RASP, rsRNASP, MCQ)
5. **Report** — summary.md + PyMOL visualization scripts

## Adding a new tool wrapper

1. Create `rnapipey/tools/<toolname>.py` extending `BaseTool`
2. Implement `check()` (returns bool) and `run()` (returns ToolResult)
3. Add a config dataclass in `config.py` (e.g. `FarfarConfig`)
4. Add the config field to `ToolsConfig`
5. Register in `cli.py` (add `--<toolname>` flag + import in `check` and `run`)
6. Add to `pipeline.py` predictor dispatch
7. Add config section in `install_tools.sh` `generate_config()`

## Common patterns

- All tool wrappers extend `BaseTool` with `check()` and `run()` methods
- Tools are configured via dataclasses in `config.py` (RhoFoldConfig, SimRNAConfig, etc.)
- `_run_cmd()` captures stdout/stderr to log files and returns CmdResult
- Protenix has no CLI binary — uses `python -m protenix.predict`
- RhoFold+ needs `--single_seq_pred True` (takes a value, not a bare flag)
- RNAdvisor CLI uses `--pred_dir` and `--scores` (not --pdb/--metrics)
- RNAdvisor requires Docker for its scoring backends

## Ensemble diversity (RhoFold+)

RhoFold+ is fully deterministic — different seeds alone produce identical structures. Two CLI flags enable stochastic diversity:

- `--mc-dropout` — re-enables dropout layers at inference (MC Dropout / Bayesian approximation)
- `--noise-scale FLOAT` — adds Gaussian noise to input token embeddings (default 0.0 = off)

The first seed (seed 0) always runs **vanilla** (no dropout, no noise) as a deterministic baseline. Stochastic methods apply only to remaining seeds.

Implementation flow: `cli.py` → `pipeline.run()` → `_run_stage3()` → `_run_rhofold_ensemble()` → `RhoFoldTool.run_batch()` → subprocess `scripts/batch_rhofold.py` (which handles `--mc_dropout` and `--noise_scale` args).

## Known issues

- RNAdvisor Docker score merging sometimes fails to produce CSV output (scores appear in container logs but `merge_dfs` returns empty)
- MCQ metric returns NaN without a native reference structure
- RhoFold+ auto-downloads weights from HuggingFace on first run (~400MB)
- SPOT-RNA requires a separate Python 3.6 environment (TensorFlow 1.14)

## install_tools.sh flags

```
--all       Install everything
--rfam      Download Rfam database + cmpress
--rhofold   Clone RhoFold+, download weights
--spotrna   Clone SPOT-RNA + download models
--simrna    Download SimRNA binary (auto-detects macOS/Linux)
--docker    Install Docker CLI + Colima via Homebrew (macOS)
--config-only  Regenerate configs/local.yaml
```
